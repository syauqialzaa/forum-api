name: Continuous Integration

on:
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: ['14.x']

    services:
        postgres:
          image: postgres
          env:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: forum_api_test

          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 5432:5432
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    - name: npm install migrate and test
      run: |
        npm install
        npm run migrate up
        npm run test
      env:
        CI: true
        HOST: localhost
        PORT: 8000
        PGHOST: localhost
        PGPORT: 5432
        PGUSER: postgres
        PGPASSWORD: postgres
        PGDATABASE: forum_api_test
        ACCESS_TOKEN_KEY: b6e28a574ba5b697c33834c2cedcc843b42bfccb0032419856ef874c2c7d6ee95fc7d3f7205bd774d25b005158d2c326617e0779462a1510442c52d595208c24
        REFRESH_TOKEN_KEY: 8e1b5ed0c731cdba15479eae9af193a7cea97dff03489b17ec70762506fcd9c7ff30db46ef8ef14c6479aacc0513d90e486aa33fab2550bbb14dc01f2c417193
        ACCESS_TOKEN_AGE: 3000